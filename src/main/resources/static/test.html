<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>카카오맵 동적 로딩 테스트</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    // 지도를 그리는 함수
    function drawMap(appKey) {
        const container = document.getElementById('map');
        const options = {
            center: new kakao.maps.LatLng(37.566826, 126.9786567),
            level: 3
        };
        const map = new kakao.maps.Map(container, options);
        console.log("카카오맵 로딩 및 그리기 성공!");
    }

    // 1. 백엔드 API를 호출하여 카카오 JS 키를 받아옵니다.
    fetch('/api/keys/kakao')
        .then(response => response.text())
        .then(appKey => {
            // 2. 받아온 키를 사용하여 카카오맵 스크립트 태그를 동적으로 생성합니다.
            const script = document.createElement('script');
            script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${appKey}&autoload=false`;
            document.head.appendChild(script);

            // 3. 스크립트 로딩이 완료되면, kakao.maps.load를 호출하여 지도를 그립니다.
            script.onload = () => {
                kakao.maps.load(() => drawMap(appKey));
            };
        })
        .catch(error => console.error('카카오 키를 가져오는 데 실패했습니다.', error));
</script>
</body>
</html>